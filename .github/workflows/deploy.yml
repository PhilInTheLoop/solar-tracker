name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup and Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script_stop: true
          script: |
            set -e

            APP_DIR="/opt/solar-tracker"
            REPO_URL="https://github.com/PhilInTheLoop/solar-tracker.git"

            # === INITIAL SETUP (runs only if app not yet installed) ===
            if [ ! -d "$APP_DIR" ]; then
              echo "=== First-time setup ==="

              # Clone repository
              git clone "$REPO_URL" "$APP_DIR"
              cd "$APP_DIR"

              # Create virtual environment
              python3 -m venv venv
              source venv/bin/activate
              pip install -r requirements.txt

              chmod +x deploy.sh

              # Create systemd service
              cat > /etc/systemd/system/solar-tracker.service << 'SVCEOF'
            [Unit]
            Description=Solar Tracker App
            After=network.target

            [Service]
            Type=simple
            User=root
            WorkingDirectory=/opt/solar-tracker
            ExecStart=/opt/solar-tracker/venv/bin/uvicorn backend.main:app --host 127.0.0.1 --port 8003
            Restart=always
            RestartSec=5

            [Install]
            WantedBy=multi-user.target
            SVCEOF

              systemctl daemon-reload
              systemctl enable solar-tracker

              # Create nginx config
              cat > /etc/nginx/sites-available/solar-tracker << 'NGXEOF'
            server {
                listen 80;
                server_name solar.thiel.ph;

                location / {
                    proxy_pass http://127.0.0.1:8003;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_set_header X-Forwarded-Host $host;
                }
            }
            NGXEOF

              ln -sf /etc/nginx/sites-available/solar-tracker /etc/nginx/sites-enabled/
              nginx -t && systemctl reload nginx

              # Start service
              systemctl start solar-tracker
              echo "=== Initial setup complete ==="

            else
              # === REGULAR DEPLOYMENT ===
              echo "=== Deploying update ==="
              /opt/solar-tracker/deploy.sh
            fi

            # Health check
            sleep 2
            if curl -sf http://127.0.0.1:8003/api/health; then
              echo ""
              echo "=== Deployment successful! ==="
            else
              echo "=== Health check failed ==="
              systemctl status solar-tracker --no-pager || true
              exit 1
            fi
